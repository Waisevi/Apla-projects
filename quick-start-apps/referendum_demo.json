{
    "name": "Referendum",
    "data": [
        {
            "Conditions": "ContractAccess(\"@1EditMenu\")",
            "Value": "MenuItem(Title:Referendum, Page:referendums_list, Icon:\"fa fa-gavel\")",
            "Name": "default_menu",
            "Type": "menu"
        },
        {
            "Name": "referendum",
            "Trans": "{\"en\":\"Referendum\",\"ru\":\"Референдум\"}",
            "Type": "languages"
        },
        {
            "Name": "total_votes",
            "Trans": "{\"en\":\"Total votes\",\"ru\":\"Всего проголосовало\"}",
            "Type": "languages"
        },
        {
            "Name": "votes_taken_accept",
            "Trans": "{\"ru\":\"Положительных голосов\",\"en\":\"Positive votes\"}",
            "Type": "languages"
        },
        {
            "Name": "votes_taken_reject",
            "Trans": "{\"ru\":\"Отрицательных голосов\",\"en\":\"Negative votes\"}",
            "Type": "languages"
        },
        {
            "Name": "referendums",
            "Columns": "[{\"name\":\"question\",\"type\":\"text\",\"conditions\":\"true\"},{\"name\":\"votes_total\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"votes_accept\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"votes_reject\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"percent_accept\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"percent_reject\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"name\",\"type\":\"text\",\"conditions\":\"true\"},{\"name\":\"delete\",\"type\":\"number\",\"conditions\":\"true\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Name": "referendums_participants",
            "Columns": "[{\"name\":\"decision\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"member_id\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"referendum_id\",\"type\":\"number\",\"conditions\":\"true\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Conditions": "ContractAccess(\"@1EditPage\")",
            "Value": "Div(Class: content-wrapper){\r\n\r\n\tSetTitle(New referendum)\r\n\tDiv(Class: breadcrumb){\r\n\t\tLinkPage(Referendums, referendums_list)\r\n\t\tSpan(/).Style(margin-right: 10px; margin-left: 10px;)\r\n\t\tSpan(Class: text-muted, Body: New referendum)\r\n\t}\r\n\r\n    Div(Class: row df f-valign){\r\n        Div(Class: col-md-3)\r\n        Div(Class: col-md-6){\r\n\t\t\r\n            Div(Class: panel panel-primary){\r\n                Div(Class: panel-heading, Body: New referendum)\r\n                Form(){\r\n\r\n                    Div(Class: list-group-item){\r\n                        Div(Class: row df f-valign){\r\n                \t\t\tDiv(Class: col-md-3 mt-sm text-right){\r\n                                Label(For: referendum_name){\r\n                                    Span(Body:Name)\r\n                                }\r\n                \t\t\t}\r\n                \t\t\tDiv(Class: col-md-9 mc-sm text-left){\r\n                \t\t\t    Input(Name: referendum_name, Class: form-control, Type: text)\r\n                \t\t\t}\r\n                        }                   \r\n                    }\r\n\r\n                    Div(Class: list-group-item){\r\n                        Div(Class: row df f-valign){\r\n                \t\t\tDiv(Class: col-md-3 mt-lg text-right){\r\n                                Label(For: question){\r\n                                    Span(Body: Description)\r\n                                }\r\n                            }\r\n                \t\t\tDiv(Class: col-md-9 mc-sm text-left){\r\n                \t\t\t    Input(Name: question, Class: form-control, Type: textarea)\r\n                \t\t\t}\r\n                        }                      \r\n                    }\r\n\r\n                    Div(Class: panel-footer clearfix){\r\n                        Div(Class: pull-right){\r\n                            Button(Body: Back, Class: btn btn-default, Page: referendums_list)\r\n                            Button(Body: Create, Class: btn btn-primary, Page: referendums_list, Contract: referendums_add)\r\n                        }\r\n                    }\r\n\r\n                }\r\n            }\r\n\t\t}\r\n\t\tDiv(Class: col-md-3)\r\n    }\r\n}",
            "Name": "referendums_add",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractAccess(\"@1EditPage\")",
            "Value": "Div(Class: content-wrapper){\r\n    SetTitle(Referendums)\r\n    \r\n    If(GetVar(isSearch) == 1){\r\n        SetVar(Name: v_Where, Value: \"name='#v_Search#' and delete = 0\")\r\n    }.Else{\r\n        SetVar(Name: v_Where, Value: \"delete=0\")\r\n        SetVar(Name: v_Search, Value: \"\")\r\n    }\r\n    \r\n    DBFind(Name: referendums, Source: src_referendums).Custom(custom_id){\r\n\t\tSpan(#id#)\r\n    }.Custom(custom_name){\r\n        LinkPage(Page: referendums_view, PageParams: \"referendum_id=#id#\"){\r\n            Span(Class: h4 text-bold, Body: #name#)\r\n        }\r\n    }.Custom(custom_all){\r\n        Span(Class: h5, Body: #votes_total#)\r\n    }.Custom(custom_accept){\r\n        Span(Class: h5 text-success, Body: #votes_accept# ( #percent_accept# %))\r\n    }.Custom(custom_reject){\r\n        Span(Class: h5 text-danger, Body: #votes_reject# ( #percent_reject# %))\r\n    }.Custom(custom_voting){\r\n        SetVar(Name: participant_id, Value: 0)\r\n        DBFind(Name: referendums_participants, Source: src_referendums_participants).Where(\"referendum_id=#id# and member_id=#key_id#\").Vars(participant)\r\n        If(#participant_id# > 0){\r\n        }.Else{\r\n            Div(Class: pull-right){\r\n                Button(Body: Em(Class: fa fa-thumbs-down), Class: btn btn-danger, Contract: referendums_reject, Params: \"referendum_id=#id#\", Page: referendums_list)\r\n            }\r\n            Div(Class: pull-right){\r\n                Button(Body: Em(Class: fa fa-thumbs-up), Class: btn btn-success, Contract: referendums_accept, Params: \"referendum_id=#id#\", Page: referendums_list)\r\n            }\r\n        }\r\n    }.Custom(custom_question){\r\n        Span(Class: h6, Body: #question#)\r\n    }.Where(#v_Where#).Order(id)\r\n    \r\n    Div(Class: panel panel-primary){\r\n        Form(){\r\n            Div(Class: list-group-item){\r\n                Div(Class: row df f-valign){\r\n                    Div(Class: col-md-1 mt-sm text-right){\r\n                        Label(For: Search){\r\n                            Span(Body: Name)\r\n                        }\r\n                    }\r\n                    Div(Class: col-md-11 mc-sm){\r\n                        Div(Class: input-group){\r\n                            Input(Class: form-control, Type: text, Name: Search, Value: #v_Search#)\r\n                            Div(Class: input-group-btn){\r\n                                Button(Body: Em(Class: fa fa-search), Class: btn btn-default, Page: referendums_list, PageParams: \"isSearch=1,v_Search=Val(Search)\")\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            \r\n            Div(Class: list-group-item){\r\n                Table(src_referendums, \"ID=custom_id,Name=custom_name,Description=custom_question,Positive votes=custom_accept,Negative votes=custom_reject,Total votes=custom_all,=custom_voting\")\r\n                If(GetVar(isSearch) == 1){\r\n                    Div(Class: text-center){\r\n                        Button(Body: View all, Class: btn btn-primary, Page: referendums_list, PageParams: \"isSearch=0\")\r\n                    }\r\n                }\r\n            }\r\n            \r\n            Div(Class: panel-footer clearfix){\r\n                Div(Class: pull-right){\r\n                    Button(Body: Create, Class: btn btn-primary, Page: referendums_add)\r\n                }\r\n            }\r\n            \r\n        }\r\n    }\r\n}",
            "Name": "referendums_list",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractAccess(\"@1EditPage\")",
            "Value": "Div(Class: content-wrapper){\r\n    If(#notific_id# > 0){\r\n        DBFind(Name: notifications, Source: src_notifications).Columns(\"page_params->referendum_id\").Where(\"id=#notific_id#\").Vars(prefix)\r\n        SetVar(referendum_id, #prefix_page_params_referendum_id#)\r\n    }\r\n\r\n    If(#referendum_id# > 0){\r\n        DBFind(Name: referendums, Source: src_referendums).Where(\"id=#referendum_id#\").Vars(instance)\r\n        DBFind(Name: referendums_participants, Source: src_referendums_participants).Where(\"referendum_id=#referendum_id# and member_id=#key_id#\").Vars(participant)\r\n\r\n        SetTitle(Referendum: #instance_name#)\r\n        Div(Class: breadcrumb){\r\n            LinkPage(Referendums, referendums_list)\r\n            Span(/).Style(margin-right: 10px; margin-left: 10px;)\r\n            Span(Class: text-muted, Body: #instance_name#)\r\n        }\r\n\r\n        Div(Class: row df f-valign){\r\n            Div(Class: col-md-2)\r\n            Div(Class: col-md-8){\r\n\r\n                Div(Class: panel panel-default){\r\n                    Form(){ \r\n\r\n                        Div(Class: list-group-item text-center){\r\n                            P(Class: h2 text-bold m0, Body: #instance_name#)\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-12 mt-sm){\r\n\t\t\t\t\t\t\t\t\tP(Class: h5 text-muted m0, Body: Total votes: #instance_votes_total#)\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n                        }\r\n                        Div(Class: list-group-item text-center){\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm)\r\n                                Div(Class: col-md-8 mt-sm){\r\n\t\t\t\t\t\t\t\t\tP(Class: h4 text-normal m0, Body: #instance_question#)\r\n\t\t\t\t\t\t\t\t}\r\n                                Div(Class: col-md-2 mt-sm)\r\n\t\t\t\t\t\t\t}\r\n                        }\r\n                        Div(Class: list-group-item text-center){\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm )\r\n                                Div(Class: col-md-4 mt-sm text-left){\r\n\t\t\t\t\t\t\t\t\tP(Class: h5 text-success m0, Body: Positive votes)\r\n                                }\r\n                                Div(Class: col-md-4 mt-sm text-right){\r\n\t\t\t\t\t\t\t\t\tP(Class: h5 text-danger m0, Body: Negative votes)\r\n                                }\r\n                                Div(Class: col-md-2 mt-sm)\r\n                            }\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm )\r\n                                Div(Class: col-md-8 mt-sm text-center){\r\n                                    If(Or(#instance_percent_accept#>0,#instance_percent_reject#>0)){\r\n                                        Div().Style(background-color:green;height:10px;display:inline-block;width:#instance_percent_accept#%)\r\n                                        Div().Style(background-color:red;height:10px;display:inline-block;width:#instance_percent_reject#%)\r\n                                    }.Else{\r\n                                        Div().Style(background-color:LightGray;height:10px;display:inline-block;width:100%)\r\n                                    }\r\n                                }\r\n                                Div(Class: col-md-2 mt-sm)\r\n                            }\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm )\r\n                                Div(Class: col-md-4 mt-sm text-left){\r\n                                    P(Class: h5 text-success m0, Body: #instance_percent_accept# % (#instance_votes_accept#))\r\n                                }\r\n                                Div(Class: col-md-4 mt-sm text-right){\r\n                                    P(Class: h5 text-danger m0, Body: #instance_percent_reject# % (#instance_votes_reject#))\r\n                                }\r\n                                Div(Class: col-md-2 mt-sm)\r\n                            }\r\n\t\t\t\t\t\t}\r\n                        If(#participant_id# > 0){\r\n                        }.Else{\r\n                            Div(Class: list-group-item text-center){\r\n                                Div(Class: row df f-valign){\r\n                                    Div(Class: col-md-1 mt-sm )\r\n                                    Div(Class: col-md-5 mt-sm text-center){\r\n                                        Button(Body: Em(Class: fa fa-thumbs-up), Class: btn btn-success, Contract: referendums_accept, Params: \"referendum_id=#referendum_id#\", Page: referendums_view, PageParams: \"referendum_id=#referendum_id#\")\r\n                                    }\r\n                                    Div(Class: col-md-5 mt-sm text-center){\r\n                                        Button(Body: Em(Class: fa fa-thumbs-down), Class: btn btn-danger, Contract: referendums_reject, Params: \"referendum_id=#referendum_id#\", Page: referendums_view, PageParams: \"referendum_id=#referendum_id#\")\r\n                                    }\r\n                                    Div(Class: col-md-1 mt-sm)\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                    }\r\n                }\r\n\r\n            }\r\n            Div(Class: col-md-2)\r\n        }   \r\n    }.Else{\r\n        Div(Class: md-12 alert alert-danger text-center){\r\n            Span(Body: Parameters not received)\r\n        }\r\n    }\r\n}",
            "Name": "referendums_view",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract referendums_accept {\r\n    data {\r\n        referendum_id int\r\n    }\r\n\r\n    conditions {\r\n        $referendums_map = DBFind(\"referendums\").Where(\"id=$\", $referendum_id).Row()\r\n        if !$referendums_map {\r\n            warning \"Referendum not found\"\r\n        }\r\n\r\n\t\t$participant_id = DBFind(\"referendums_participants\").Where(\"referendum_id=$ and member_id=$\", $referendum_id, $key_id).One(\"id\")\r\n        if $participant_id {\r\n\t\t\twarning \"You already voted\"\r\n\t\t}\r\n\r\n        $votes_total = Int($referendums_map[\"votes_total\"])\r\n        $votes_accept = Int($referendums_map[\"votes_accept\"])\r\n        $votes_reject = Int($referendums_map[\"votes_reject\"])\r\n        $percent_accept = Int($referendums_map[\"percent_accept\"])\r\n        $percent_reject = Int($referendums_map[\"percent_reject\"])\r\n    }\r\n\r\n    action {\r\n        $votes_total = $votes_total + 1\r\n        $votes_accept = $votes_accept + 1\r\n\r\n        $percent_accept = $votes_accept * 100 / $votes_total\r\n        $percent_reject = 100 - $percent_accept\r\n\r\n        DBUpdate(\"referendums\", $referendum_id, \"votes_total,votes_accept,votes_reject,percent_accept,percent_reject\", $votes_total, $votes_accept, $votes_reject, $percent_accept, $percent_reject)\r\n        DBInsert(\"referendums_participants\", \"referendum_id,member_id,decision\", $referendum_id, $key_id, 1)\r\n\r\n        $notific_id = DBFind(\"notifications\").Where(\"page_name=$ and page_params->referendum_id=$ and recipient->member_id=$ and closed=$\", \"referendums_view\", $referendum_id, $key_id, 0).One(\"id\")\r\n        if ($notific_id != nil){\r\n            notifications_Close(\"notific_id\", Int($notific_id))\r\n\t\t}\r\n    }\r\n}",
            "Name": "referendums_accept",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract referendums_add {\r\n    data {\r\n        referendum_name string\r\n        question string\r\n    }\r\n\r\n    conditions {}\r\n\r\n    action {\r\n        $referendum_id = DBInsert(\"referendums\", \"name,question\", $referendum_name, $question)\r\n\r\n        $ret_member = DBFind(\"members\").Where(\"id != $\", 0).Order(\"id\")\r\n        $i = 0\r\n        while($i < Len($ret_member)){\r\n            $vals_member = $ret_member[$i]\r\n            \r\n\t\t\tvar params map\r\n\t\t\tparams[\"referendum_id\"] = $referendum_id\r\n\t\t\tnotifications_Send(\"member_id,sender,icon_name,text_header,text_body,page_name,params_map\", \r\n\t\t\t\t$vals_member[\"id\"], 1, \"fa-check\", \"Referendum\", $referendum_name, \"referendums_view\", params)\r\n\r\n            $i = $i + 1\r\n        } \r\n    }\r\n}",
            "Name": "referendums_add",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract referendums_reject {\r\n    data {\r\n        referendum_id int\r\n    }\r\n\r\n    conditions {\r\n        $referendums_map = DBFind(\"referendums\").Where(\"id=$\", $referendum_id).Row()\r\n        if !$referendums_map {\r\n            warning \"Referendum not found\"\r\n        }\r\n\r\n\t\t$participant_id = DBFind(\"referendums_participants\").Where(\"referendum_id=$ and member_id=$\", $referendum_id, $key_id).One(\"id\")\r\n        if $participant_id {\r\n\t\t\twarning \"You already voted\"\r\n\t\t}\r\n\r\n        $votes_total = Int($referendums_map[\"votes_total\"])\r\n        $votes_accept = Int($referendums_map[\"votes_accept\"])\r\n        $votes_reject = Int($referendums_map[\"votes_reject\"])\r\n        $percent_accept = Int($referendums_map[\"percent_accept\"])\r\n        $percent_reject = Int($referendums_map[\"percent_reject\"])\r\n    }\r\n\r\n    action {\r\n        $votes_total = $votes_total + 1\r\n        $votes_reject = $votes_reject + 1\r\n\r\n        $percent_accept = $votes_accept * 100 / $votes_total\r\n        $percent_reject = 100 - $percent_accept\r\n\r\n        DBUpdate(\"referendums\", $referendum_id, \"votes_total,votes_accept,votes_reject,percent_accept,percent_reject\", $votes_total, $votes_accept, $votes_reject, $percent_accept, $percent_reject)\r\n        DBInsert(\"referendums_participants\", \"referendum_id,member_id,decision\", $referendum_id, $key_id, -1)\r\n\r\n        $notific_id = DBFind(\"notifications\").Where(\"page_name=$ and page_params->referendum_id=$ and recipient->member_id=$ and closed=$\", \"referendums_view\", $referendum_id, $key_id, 0).One(\"id\")\r\n        if ($notific_id != nil){\r\n            notifications_Close(\"notific_id\", Int($notific_id))\r\n\t\t}\r\n    }\r\n}",
            "Name": "referendums_reject",
            "Type": "contracts"
        }
    ]
}